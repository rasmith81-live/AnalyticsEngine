version: '3.8'

services:
  # Database Service - Centralized database operations with CQRS
  database_service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_DIR: services/backend_services/database_service
    ports:
      - "8000:8000"
    environment:
      - SERVICE_NAME=database_service
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@timescaledb:5432/${POSTGRES_DB}
      - REDIS_URL=redis://redis:6379
      - OBSERVABILITY_SERVICE_URL=http://observability_service:8000
      - RUN_MIGRATIONS_ON_STARTUP=1
      - OTEL_EXPORTER_OTLP_ENDPOINT=https://observability_service:4317
      - OTEL_EXPORTER_OTLP_INSECURE=false
      - OTEL_EXPORTER_OTLP_CERTIFICATE=/certs/server.crt
      - SCHEMA_VALIDATION_LEVEL=basic
      - AUTO_ROLLBACK_ON_FAILURE=false
      - MONITORING_ENABLED=true
      - TIMESCALE_CHUNK_INTERVAL=7 days
      - METRICS_RETENTION_PERIOD=365 days
      - PYTHONPATH=.
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - .:/app
      - ./certs:/certs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Messaging Service - Centralized Redis operations and pub/sub
  messaging_service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_DIR: services/backend_services/messaging_service
    ports:
      - "8002:8000"
    environment:
      - SERVICE_NAME=messaging_service
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@timescaledb:5432/${POSTGRES_DB}
      - OBSERVABILITY_SERVICE_URL=http://observability_service:8000
      - OTEL_EXPORTER_OTLP_ENDPOINT=https://observability_service:4317
      - OTEL_EXPORTER_OTLP_INSECURE=false
      - OTEL_EXPORTER_OTLP_CERTIFICATE=/certs/server.crt
      - ENABLE_DISTRIBUTED_TRACING=true
      - METRICS_EXPORT_TIMEOUT=5
      - PYTHONPATH=/app/services/backend_services/messaging_service:/app
    depends_on:
      redis:
        condition: service_healthy
      timescaledb:
        condition: service_healthy
      prometheus-pushgateway:
        condition: service_healthy
    volumes:
      - .:/app
      - ./certs:/certs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Archival Service - TimescaleDB data archival to lakehouse
  archival_service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_DIR: services/backend_services/archival_service
    ports:
      - "8005:8000"
    environment:
      - SERVICE_NAME=archival_service
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@timescaledb:5432/${POSTGRES_DB}
      - REDIS_URL=redis://redis:6379
      - DATABASE_SERVICE_URL=http://database_service:8000
      - LAKEHOUSE_STORAGE_ACCOUNT=${AZURE_STORAGE_ACCOUNT:-devstoreaccount1}
      - LAKEHOUSE_CONTAINER=${AZURE_STORAGE_CONTAINER:-timescaledb-archive}
      - LAKEHOUSE_CONNECTION_STRING=${AZURE_STORAGE_CONNECTION_STRING:-DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;}
      - OTEL_EXPORTER_OTLP_ENDPOINT=https://observability_service:4317
      - OTEL_EXPORTER_OTLP_INSECURE=false
      - OTEL_EXPORTER_OTLP_CERTIFICATE=/certs/server.crt
      - PYTHONPATH=.
    depends_on:
      database_service:
        condition: service_healthy
      redis:
        condition: service_healthy
      azurite:
        condition: service_started
    volumes:
      - .:/app
      - ./certs:/certs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Observability Service - Centralized monitoring and tracing
  observability_service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_DIR: services/backend_services/observability_service
    ports:
      - "8080:8000"
      - "4317:4317"
    environment:
      - SERVICE_NAME=observability_service
      - HOST=0.0.0.0
      - PORT=8000
      - DEBUG=true
      - TIMESCALE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@timescaledb:5432/${POSTGRES_DB}
      - REDIS_URL=redis://redis:6379/0
      - ELASTICSEARCH_URL=none
      - LOGS_INDEX=service-logs
      - OTLP_ENDPOINT=0.0.0.0:4317
      - OPENTELEMETRY_ENDPOINT=0.0.0.0:4317
      - PROMETHEUS_ENDPOINT=http://localhost:9090
      - NOTIFICATION_ENDPOINTS={"email":"none","slack":"none"}
      - ALLOWED_ORIGINS=http://localhost:3000,http://127.0.0.1:3000
      - API_KEY_HEADER=X-API-Key
      - API_KEYS={}
      - METRICS_RETENTION_DAYS=30
      - TRACES_RETENTION_DAYS=7
      - LOGS_RETENTION_DAYS=14
      - BATCH_SIZE=1000
      - WORKER_THREADS=4
      - PYTHONPATH=.
      - MESSAGING_SERVICE_URL=http://messaging_service:8000
      - SERVICE_URL=http://observability_service:8000
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
      messaging_service:
        condition: service_healthy
    volumes:
      - .:/app
      - ./certs:/certs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Business Metadata Service (formerly analytics_metadata_service)
  business_metadata:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_DIR: services/business_services/business_metadata
    ports:
      - "8020:8000"
    environment:
      - SERVICE_NAME=business_metadata
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@timescaledb:5432/${POSTGRES_DB}
      - REDIS_URL=redis://redis:6379
      - DATABASE_SERVICE_URL=http://database_service:8000
      - MESSAGING_SERVICE_URL=http://messaging_service:8000
      - OBSERVABILITY_SERVICE_URL=http://observability_service:8000
      - OTEL_EXPORTER_OTLP_ENDPOINT=https://observability_service:4317
      - OTEL_EXPORTER_OTLP_INSECURE=false
      - OTEL_EXPORTER_OTLP_CERTIFICATE=/certs/server.crt
      - ENABLE_DISTRIBUTED_TRACING=true
      - ENABLE_PROMETHEUS_METRICS=true
      - PROMETHEUS_PUSH_GATEWAY=http://prometheus-pushgateway:9091
      - METRICS_PUSH_INTERVAL=15
      - ENABLE_CACHE=true
      - CACHE_TTL=3600
      - PYTHONPATH=/app/services/business_services:/app
    depends_on:
      database_service:
        condition: service_healthy
      messaging_service:
        condition: service_healthy
      observability_service:
        condition: service_healthy
      prometheus-pushgateway:
        condition: service_healthy
    volumes:
      - .:/app
      - ./certs:/certs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Calculation Engine Service
  calculation_engine_service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_DIR: services/business_services/calculation_engine_service
    ports:
      - "8021:8000"
    environment:
      - SERVICE_NAME=calculation_engine_service
      - DATABASE_SERVICE_URL=http://database_service:8000
      - MESSAGING_SERVICE_URL=http://messaging_service:8000
      - METADATA_SERVICE_URL=http://business_metadata:8000
      - OBSERVABILITY_SERVICE_URL=http://observability_service:8000
      - REDIS_URL=redis://redis:6379
      - OTEL_EXPORTER_OTLP_ENDPOINT=https://observability_service:4317
      - OTEL_EXPORTER_OTLP_INSECURE=false
      - OTEL_EXPORTER_OTLP_CERTIFICATE=/certs/server.crt
      - ENABLE_DISTRIBUTED_TRACING=true
      - ENABLE_PROMETHEUS_METRICS=true
      - PROMETHEUS_PUSH_GATEWAY=http://prometheus-pushgateway:9091
      - METRICS_PUSH_INTERVAL=15
      - CACHE_ENABLED=true
      - CACHE_TTL=3600
      - PYTHONPATH=/app/services/business_services:/app/services/backend_services:/app
    depends_on:
      database_service:
        condition: service_healthy
      messaging_service:
        condition: service_healthy
      business_metadata:
        condition: service_healthy
      observability_service:
        condition: service_healthy
      prometheus-pushgateway:
        condition: service_healthy
    volumes:
      - .:/app
      - ./certs:/certs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Demo/Config Service
  demo_config_service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_DIR: services/business_services/demo_config_service
    ports:
      - "8022:8000"
    environment:
      - SERVICE_NAME=demo_config_service
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@timescaledb:5432/${POSTGRES_DB}
      - REDIS_URL=redis://redis:6379
      - DATABASE_SERVICE_URL=http://database_service:8000
      - MESSAGING_SERVICE_URL=http://messaging_service:8000
      - METADATA_SERVICE_URL=http://business_metadata:8000
      - OBSERVABILITY_SERVICE_URL=http://observability_service:8000
      - OTEL_EXPORTER_OTLP_ENDPOINT=https://observability_service:4317
      - OTEL_EXPORTER_OTLP_INSECURE=false
      - OTEL_EXPORTER_OTLP_CERTIFICATE=/certs/server.crt
      - ENABLE_DISTRIBUTED_TRACING=true
      - ENABLE_PROMETHEUS_METRICS=true
      - PROMETHEUS_PUSH_GATEWAY=http://prometheus-pushgateway:9091
      - METRICS_PUSH_INTERVAL=15
      - DEFAULT_HOURLY_RATE=150.0
      - BATCH_INTEGRATION_HOURS_PER_OBJECT=8
      - REALTIME_INTEGRATION_HOURS_PER_OBJECT=16
      - PYTHONPATH=/app/services/business_services:/app/services/backend_services:/app
    depends_on:
      database_service:
        condition: service_healthy
      messaging_service:
        condition: service_healthy
      business_metadata:
        condition: service_healthy
      observability_service:
        condition: service_healthy
      prometheus-pushgateway:
        condition: service_healthy
    volumes:
      - .:/app
      - ./certs:/certs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Data Simulator Service
  data_simulator_service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_DIR: services/business_services/data_simulator_service
    ports:
      - "8007:8000"
    environment:
      - SERVICE_NAME=data_simulator_service
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@timescaledb:5432/${POSTGRES_DB}
      - REDIS_URL=redis://redis:6379
      - DATABASE_SERVICE_URL=http://database_service:8000
      - MESSAGING_SERVICE_URL=http://messaging_service:8000
      - METADATA_SERVICE_URL=http://metadata_ingestion_service:8000
      - OBSERVABILITY_SERVICE_URL=http://observability_service:8000
      - OTEL_EXPORTER_OTLP_ENDPOINT=https://observability_service:4317
      - OTEL_EXPORTER_OTLP_INSECURE=false
      - OTEL_EXPORTER_OTLP_CERTIFICATE=/certs/server.crt
      - PYTHONPATH=/app/services/business_services:/app/services/backend_services:/app
    depends_on:
      database_service:
        condition: service_healthy
      messaging_service:
        condition: service_healthy
      metadata_ingestion_service:
        condition: service_healthy
    volumes:
      - .:/app
      - ./certs:/certs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Connector Service
  connector_service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_DIR: services/business_services/connector_service
    ports:
      - "8023:8000"
    environment:
      - SERVICE_NAME=connector_service
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@timescaledb:5432/${POSTGRES_DB}
      - REDIS_URL=redis://redis:6379
      - DATABASE_SERVICE_URL=http://database_service:8000
      - MESSAGING_SERVICE_URL=http://messaging_service:8000
      - OBSERVABILITY_SERVICE_URL=http://observability_service:8000
      - OTEL_EXPORTER_OTLP_ENDPOINT=https://observability_service:4317
      - OTEL_EXPORTER_OTLP_INSECURE=false
      - OTEL_EXPORTER_OTLP_CERTIFICATE=/certs/server.crt
      - PYTHONPATH=/app/services/business_services:/app/services/backend_services:/app
    depends_on:
      database_service:
        condition: service_healthy
      messaging_service:
        condition: service_healthy
    volumes:
      - .:/app
      - ./certs:/certs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Ingestion Service
  ingestion_service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_DIR: services/business_services/ingestion_service
    ports:
      - "8024:8000"
    environment:
      - SERVICE_NAME=ingestion_service
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@timescaledb:5432/${POSTGRES_DB}
      - REDIS_URL=redis://redis:6379
      - DATABASE_SERVICE_URL=http://database_service:8000
      - MESSAGING_SERVICE_URL=http://messaging_service:8000
      - CONNECTOR_SERVICE_URL=http://connector_service:8000
      - OBSERVABILITY_SERVICE_URL=http://observability_service:8000
      - OTEL_EXPORTER_OTLP_ENDPOINT=https://observability_service:4317
      - OTEL_EXPORTER_OTLP_INSECURE=false
      - OTEL_EXPORTER_OTLP_CERTIFICATE=/certs/server.crt
      - PYTHONPATH=/app/services/business_services:/app/services/backend_services:/app
    depends_on:
      database_service:
        condition: service_healthy
      messaging_service:
        condition: service_healthy
    volumes:
      - .:/app
      - ./certs:/certs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Metadata Ingestion Service
  metadata_ingestion_service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_DIR: services/business_services/metadata_ingestion_service
    ports:
      - "8025:8000"
    environment:
      - SERVICE_NAME=metadata_ingestion_service
      - DATABASE_SERVICE_URL=http://database_service:8000
      - MESSAGING_SERVICE_URL=http://messaging_service:8000
      - BUSINESS_METADATA_URL=http://business_metadata:8000
      - ENTITY_RESOLUTION_SERVICE_URL=http://entity_resolution_service:8000
      - OBSERVABILITY_SERVICE_URL=http://observability_service:8000
      - OTEL_EXPORTER_OTLP_ENDPOINT=https://observability_service:4317
      - OTEL_EXPORTER_OTLP_INSECURE=false
      - OTEL_EXPORTER_OTLP_CERTIFICATE=/certs/server.crt
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@timescaledb:5432/${POSTGRES_DB}
      - REDIS_URL=redis://redis:6379
      - PYTHONPATH=/app/services/business_services:/app/services/backend_services:/app
    depends_on:
      database_service:
        condition: service_healthy
      messaging_service:
        condition: service_healthy
      business_metadata:
        condition: service_healthy
      entity_resolution_service:
        condition: service_healthy
    volumes:
      - .:/app
      - ./certs:/certs
      - spacy_models:/home/appuser/.cache
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Conversation Service
  conversation_service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_DIR: services/business_services/conversation_service
    ports:
      - "8026:8000"
    env_file:
      - .env
      - path: .env.secrets
        required: false
    environment:
      - SERVICE_NAME=conversation_service
      - DATABASE_SERVICE_URL=http://database_service:8000
      - MESSAGING_SERVICE_URL=http://messaging_service:8000
      - OBSERVABILITY_SERVICE_URL=http://observability_service:8000
      - REDIS_URL=redis://redis:6379
      - MCP_POSTGRES_ENABLED=true
      - MCP_KNOWLEDGE_GRAPH_ENABLED=true
      - MCP_WEB_SEARCH_ENABLED=${MCP_WEB_SEARCH_ENABLED:-false}
      - EXA_API_KEY=${EXA_API_KEY:-}
      - OTEL_EXPORTER_OTLP_ENDPOINT=https://observability_service:4317
      - OTEL_EXPORTER_OTLP_INSECURE=false
      - OTEL_EXPORTER_OTLP_CERTIFICATE=/certs/server.crt
      - PYTHONPATH=.
    depends_on:
      database_service:
        condition: service_healthy
      messaging_service:
        condition: service_healthy
    volumes:
      - .:/app
      - ./certs:/certs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Systems Monitor Service
  systems_monitor:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_DIR: services/support_services/systems_monitor
    ports:
      - "8010:8000"
    environment:
      - SERVICE_NAME=systems_monitor
      - DATABASE_SERVICE_URL=http://database_service:8000
      - MESSAGING_SERVICE_URL=http://messaging_service:8000
      - OBSERVABILITY_SERVICE_URL=http://observability_service:8000
      - OTEL_EXPORTER_OTLP_ENDPOINT=https://observability_service:4317
      - OTEL_EXPORTER_OTLP_INSECURE=false
      - OTEL_EXPORTER_OTLP_CERTIFICATE=/certs/server.crt
      - ENABLE_DISTRIBUTED_TRACING=true
      - ENABLE_PROMETHEUS_METRICS=true
      - METRICS_PUSH_INTERVAL=15
      - PROMETHEUS_PUSH_GATEWAY=http://prometheus-pushgateway:9091
      - METRICS_EXPORT_JOB_NAME=systems_monitor
      - PYTHONPATH=.
    depends_on:
      database_service:
        condition: service_healthy
      messaging_service:
        condition: service_healthy
      observability_service:
        condition: service_healthy
      prometheus-pushgateway:
        condition: service_healthy
    volumes:
      - .:/app
      - ./certs:/certs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Entity Resolution Service
  entity_resolution_service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_DIR: services/support_services/entity_resolution_service
    ports:
      - "8012:8000"
    env_file:
      - .env
      - path: .env.secrets
        required: false
    environment:
      - SERVICE_NAME=entity_resolution_service
      - DATABASE_SERVICE_URL=http://database_service:8000
      - MESSAGING_SERVICE_URL=http://messaging_service:8000
      - BUSINESS_METADATA_URL=http://business_metadata:8000
      - OBSERVABILITY_SERVICE_URL=http://observability_service:8000
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - AZURE_OPENAI_DEPLOYMENT=${AZURE_OPENAI_DEPLOYMENT}
      - LLM_MODEL=${LLM_MODEL:-gpt-4o-mini}
      - MOCK_LLM=${MOCK_LLM:-false}
      - OTEL_EXPORTER_OTLP_ENDPOINT=https://observability_service:4317
      - OTEL_EXPORTER_OTLP_INSECURE=false
      - OTEL_EXPORTER_OTLP_CERTIFICATE=/certs/server.crt
      - ENABLE_DISTRIBUTED_TRACING=true
      - ENABLE_PROMETHEUS_METRICS=true
      - METRICS_PUSH_INTERVAL=15
      - PROMETHEUS_PUSH_GATEWAY=http://prometheus-pushgateway:9091
      - METRICS_EXPORT_JOB_NAME=entity_resolution_service
      - PYTHONPATH=.
    depends_on:
      database_service:
        condition: service_healthy
      messaging_service:
        condition: service_healthy
      observability_service:
        condition: service_healthy
      prometheus-pushgateway:
        condition: service_healthy
    volumes:
      - .:/app
      - ./certs:/certs
      - spacy_models:/root/.cache/spacy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Data Governance Service
  data_governance_service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_DIR: services/support_services/data_governance_service
    ports:
      - "8013:8000"
    environment:
      - SERVICE_NAME=data_governance_service
      - DATABASE_SERVICE_URL=http://database_service:8000
      - MESSAGING_SERVICE_URL=http://messaging_service:8000
      - OBSERVABILITY_SERVICE_URL=http://observability_service:8000
      - OTEL_EXPORTER_OTLP_ENDPOINT=https://observability_service:4317
      - OTEL_EXPORTER_OTLP_INSECURE=false
      - OTEL_EXPORTER_OTLP_CERTIFICATE=/certs/server.crt
      - ENABLE_DISTRIBUTED_TRACING=true
      - ENABLE_PROMETHEUS_METRICS=true
      - METRICS_PUSH_INTERVAL=15
      - PROMETHEUS_PUSH_GATEWAY=http://prometheus-pushgateway:9091
      - METRICS_EXPORT_JOB_NAME=data_governance_service
      - PYTHONPATH=.
    depends_on:
      database_service:
        condition: service_healthy
      messaging_service:
        condition: service_healthy
      observability_service:
        condition: service_healthy
      prometheus-pushgateway:
        condition: service_healthy
    volumes:
      - .:/app
      - ./certs:/certs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Machine Learning Service
  machine_learning_service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_DIR: services/support_services/machine_learning_service
    ports:
      - "8014:8000"
    environment:
      - SERVICE_NAME=machine_learning_service
      - DATABASE_SERVICE_URL=http://database_service:8000
      - MESSAGING_SERVICE_URL=http://messaging_service:8000
      - OBSERVABILITY_SERVICE_URL=http://observability_service:8000
      - OTEL_EXPORTER_OTLP_ENDPOINT=https://observability_service:4317
      - OTEL_EXPORTER_OTLP_INSECURE=false
      - OTEL_EXPORTER_OTLP_CERTIFICATE=/certs/server.crt
      - ENABLE_DISTRIBUTED_TRACING=true
      - ENABLE_PROMETHEUS_METRICS=true
      - METRICS_PUSH_INTERVAL=15
      - PROMETHEUS_PUSH_GATEWAY=http://prometheus-pushgateway:9091
      - METRICS_EXPORT_JOB_NAME=machine_learning_service
      - PYTHONPATH=.
    depends_on:
      database_service:
        condition: service_healthy
      messaging_service:
        condition: service_healthy
      observability_service:
        condition: service_healthy
      prometheus-pushgateway:
        condition: service_healthy
    volumes:
      - .:/app
      - ./certs:/certs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # API Gateway - Unified interface for all services
  api_gateway:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_DIR: services/frontend_services/api_gateway
    ports:
      - "8090:8000"
    environment:
      - SERVICE_NAME=api_gateway
      - HOST=0.0.0.0
      - PORT=8000
      - DEBUG=true
      - REDIS_URL=redis://redis:6379/0
      - RATE_LIMIT=100
      - RATE_LIMIT_WINDOW=60
      - CIRCUIT_BREAKER_THRESHOLD=5
      - CIRCUIT_BREAKER_RECOVERY_TIME=30
      - CACHE_ENABLED=true
      - CACHE_TTL=300
      - HEALTH_CHECK_INTERVAL=30
      - QUERY_TIMEOUT=10
      - OTEL_EXPORTER_OTLP_ENDPOINT=https://observability_service:4317
      - OTEL_EXPORTER_OTLP_INSECURE=false
      - OTEL_EXPORTER_OTLP_CERTIFICATE=/certs/server.crt
      - PYTHONPATH=.
      - DATABASE_SERVICE_URL=http://database_service:8000
      - MESSAGING_SERVICE_URL=http://messaging_service:8000
      - OBSERVABILITY_SERVICE_URL=http://observability_service:8000
      - ARCHIVAL_SERVICE_URL=http://archival_service:8000
      - SYSTEMS_MONITOR_URL=http://systems_monitor:8000
      - ENTITY_RESOLUTION_SERVICE_URL=http://entity_resolution_service:8000
      - DATA_GOVERNANCE_SERVICE_URL=http://data_governance_service:8000
      - MACHINE_LEARNING_SERVICE_URL=http://machine_learning_service:8000
      - BUSINESS_METADATA_URL=http://business_metadata:8000
      - CALCULATION_ENGINE_SERVICE_URL=http://calculation_engine_service:8000
      - DEMO_CONFIG_SERVICE_URL=http://demo_config_service:8000
      - CONNECTOR_SERVICE_URL=http://connector_service:8000
      - INGESTION_SERVICE_URL=http://ingestion_service:8000
      - METADATA_INGESTION_SERVICE_URL=http://metadata_ingestion_service:8000
      - CONVERSATION_SERVICE_URL=http://conversation_service:8000
      - SIMULATOR_SERVICE_URL=http://data_simulator_service:8000
    depends_on:
      redis:
        condition: service_healthy
      systems_monitor:
        condition: service_healthy
      entity_resolution_service:
        condition: service_healthy
      data_governance_service:
        condition: service_healthy
      machine_learning_service:
        condition: service_healthy
      database_service:
        condition: service_healthy
      messaging_service:
        condition: service_healthy
      archival_service:
        condition: service_healthy
      observability_service:
        condition: service_healthy
      business_metadata:
        condition: service_healthy
      calculation_engine_service:
        condition: service_healthy
      demo_config_service:
        condition: service_healthy
      connector_service:
        condition: service_healthy
      ingestion_service:
        condition: service_healthy
      metadata_ingestion_service:
        condition: service_healthy
      conversation_service:
        condition: service_healthy
      data_simulator_service:
        condition: service_healthy
    volumes:
      - .:/app
      - ./certs:/certs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Demo Config UI - Frontend for Demo Configuration
  demo_config_ui:
    build:
      context: services/frontend_services/demo_config_ui
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - VITE_API_BASE_URL=http://localhost:8090
    depends_on:
      api_gateway:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # TimescaleDB - Time-series database with PostgreSQL
  timescaledb:
    image: timescale/timescaledb:latest-pg14
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    volumes:
      - timescaledb_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    command: >
      postgres
      -c shared_preload_libraries=timescaledb
      -c max_connections=200
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c work_mem=4MB
      -c maintenance_work_mem=64MB
      -c random_page_cost=1.1
      -c temp_file_limit=2GB
      -c log_min_duration_statement=200ms
      -c log_checkpoints=on
      -c log_connections=on
      -c log_disconnections=on
      -c log_lock_waits=on
      -c log_temp_files=0
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100

  # Redis - In-memory data structure store for messaging
  redis:
    image: redis/redis-stack:latest
    ports:
      - "6379:6379"
      - "8001:8001" # RedisInsight port
    command:
      - redis-stack-server
      - --dir
      - /data
      - --maxmemory
      - 256mb
      - --maxmemory-policy
      - allkeys-lru
      - --appendonly
      - yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
      
  # Azurite - Azure Storage Emulator for local development
  azurite:
    image: mcr.microsoft.com/azure-storage/azurite
    ports:
      - "10000:10000" # Blob service
      - "10001:10001" # Queue service
      - "10002:10002" # Table service
    volumes:
      - azurite_data:/data
    command: "azurite --blobHost 0.0.0.0 --queueHost 0.0.0.0 --tableHost 0.0.0.0 --loose --location /data --debug /data/debug.log"

  # Prometheus Pushgateway - Metrics collection endpoint
  prometheus-pushgateway:
    image: prom/pushgateway:latest
    ports:
      - "9091:9091"
    volumes:
      - prometheus_data:/data
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9091"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  timescaledb_data:
    driver: local
  redis_data:
    driver: local
  azurite_data:
    driver: local
  prometheus_data:
    driver: local
  spacy_models:
    driver: local

networks:
  default:
    driver: bridge
