name: Validate Migrations

on:
  pull_request:
    paths:
      - 'alembic/versions/**'
      - 'services/**/app/models.py'
      - 'services/**/app/scor/**'
      - 'services/**/app/domain/**'

jobs:
  validate-cqrs:
    name: Validate CQRS Models
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        shell: pwsh
      
      - name: Validate CQRS Models
        run: |
          cd scripts/utils
          .\validate_cqrs_models.ps1
        shell: pwsh
        continue-on-error: false
      
      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: cqrs-validation-report
          path: scripts/utils/validation_report.txt
          if-no-files-found: ignore

  check-migration-conflicts:
    name: Check Migration Conflicts
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        shell: pwsh
      
      - name: Check for migration head conflicts
        run: |
          cd scripts/utils
          .\resolve_service_heads.ps1 -CheckOnly
        shell: pwsh
        continue-on-error: false
      
      - name: Upload conflict report
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: migration-conflict-report
          path: scripts/utils/conflict_report.txt
          if-no-files-found: ignore

  validate-schema-extraction:
    name: Validate Schema Extraction
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Test schema extraction
        run: |
          cd scripts/utils
          python extract_table_schemas.py --scor
        continue-on-error: false
      
      - name: Verify schema files
        run: |
          if [ ! -d "schemas/scor" ]; then
            echo "Schema directory not created"
            exit 1
          fi
          
          file_count=$(find schemas/scor -name "*.json" | wc -l)
          if [ "$file_count" -eq 0 ]; then
            echo "No schema files generated"
            exit 1
          fi
          
          echo "Successfully generated $file_count schema files"
      
      - name: Upload schema files
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: extracted-schemas
          path: schemas/
          if-no-files-found: ignore

  migration-summary:
    name: Migration Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-cqrs, check-migration-conflicts, validate-schema-extraction]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## Migration Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| CQRS Validation | ${{ needs.validate-cqrs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Migration Conflicts | ${{ needs.check-migration-conflicts.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Schema Extraction | ${{ needs.validate-schema-extraction.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.validate-cqrs.result }}" == "success" ] && \
             [ "${{ needs.check-migration-conflicts.result }}" == "success" ] && \
             [ "${{ needs.validate-schema-extraction.result }}" == "success" ]; then
            echo "✅ All migration validations passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some migration validations failed. Please review the reports." >> $GITHUB_STEP_SUMMARY
          fi
