name: CI/CD Workflow for multiMicroservicePattern

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        # Assuming pytest is used. If not, this command should be changed.
        # You might also want to run tests for each service individually.
        run: pytest

  build_and_push:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      matrix:
        service:
          - { name: 'database_service', path: 'services/backend_services/database_service' }
          - { name: 'messaging_service', path: 'services/backend_services/messaging_service' }
          - { name: 'systems_monitor', path: 'services/business_services/systems_monitor' }
          - { name: 'controller_service', path: 'services/business_services/controller_service' }
          - { name: 'entity_resolution_service', path: 'services/business_services/entity_resolution_service' }
          - { name: 'data_governance_service', path: 'services/business_services/data_governance_service' }
          - { name: 'machine_learning_service', path: 'services/business_services/machine_learning_service' }
          - { name: 'historical_data_provider_service', path: 'services/business_services/historical_data_provider_service' }
          - { name: 'market_data_provider_service', path: 'services/business_services/market_data_provider_service' }
          - { name: 'archival_service', path: 'services/backend_services/archival_service' }
          - { name: 'observability_service', path: 'services/backend_services/observability_service' }
          - { name: 'api_gateway', path: 'services/api_gateway' }
          - { name: 'broker_service', path: 'services/business_services/broker_service' }
          - { name: 'asset_profile_service', path: 'services/business_services/asset_profile_service' }
          - { name: 'news_provider_service', path: 'services/business_services/news_provider_service' }
          - { name: 'strategy_service', path: 'services/business_services/strategy_service' }
          - { name: 'assessment_service', path: 'services/business_services/assessment_service' }
          - { name: 'allocation_service', path: 'services/business_services/allocation_service' }
          - { name: 'market_monitor', path: 'services/business_services/market_monitor' }

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push ${{ matrix.service.name }}
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          build-args: |
            SERVICE_DIR=${{ matrix.service.path }}
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ github.event.repository.name }}-${{ matrix.service.name }}:latest

  deploy:
    needs: build_and_push
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to production
        run: echo "Deploying to production... (placeholder)"
        # This step would typically involve SSHing into a server and running docker-compose up
        # Or using a deployment tool like Ansible, Kubernetes with kubectl, etc.
