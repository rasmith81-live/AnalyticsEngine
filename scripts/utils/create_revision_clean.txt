param(
    [Parameter(Mandatory = $true)]
    [string]$ServiceName,

    [string]$Message,

    [switch]$AutoGenerate
)

# Strict mode for better error handling
$ErrorActionPreference = "Stop"
# Helper function for consistent logging
function Write-Log {
    param(
        [string]$Level,
        [string]$LogMessage
    )
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    Write-Host "[$timestamp] [$Level] $LogMessage"
}

# --- Script Start ---
Write-Log "INFO" "Starting revision creation for service: '$ServiceName'."

# 1. Set Environment Variables
$projectRoot = (Resolve-Path "$PSScriptRoot/../..").Path
$env:PYTHONPATH = $projectRoot
Write-Log "INFO" "PYTHONPATH set to: '$env:PYTHONPATH'"

# 2. Prepare Database URL
$envFile = Join-Path $projectRoot ".env"
if (-not (Test-Path $envFile)) {
    Write-Log "ERROR" ".env file not found at: '$envFile'"
    exit 1
}
# Read the original async URL and create a sync version for Alembic
$dbUrlLine = Get-Content $envFile | Select-String "DATABASE_URL="
$originalDbUrl = ($dbUrlLine -split '=', 2)[1].Trim()
$syncDbUrl = $originalDbUrl.Replace("+asyncpg", "+psycopg2")
Write-Log "INFO" "Using synchronous DATABASE_URL for Alembic."

# 3. Default commit message if not provided
if (-not $Message) {
    $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
    $Message = "Auto-revision for $ServiceName at $timestamp"
    Write-Log "INFO" "Using default message: '$Message'"
}

# 4. Build docker-compose and alembic arguments using splatting for safety
$dockerComposeParams = @(
    "run", 
    "--rm",
    "--no-deps",
    "--entrypoint", "alembic",
    "-e", "SERVICE_NAME=$ServiceName",
    "-e", "DATABASE_URL=$syncDbUrl",
    $ServiceName
)

$alembicParams = @(
    "-x", "branch=$ServiceName",
    "revision",
    "--branch-label", $ServiceName,
    "-m", $Message
)

$versionPath = "alembic/versions/$ServiceName"
$alembicParams += "--version-path"
$alembicParams += $versionPath

if ($AutoGenerate) {
    $alembicParams += "--autogenerate"
}

# 5. Execute the command
Write-Log "INFO" "Executing Alembic revision command..."
try {
    # Combine and execute the full command
    & docker-compose @dockerComposeParams @alembicParams
    Write-Log "SUCCESS" "Alembic revision command completed successfully."
}
catch {
    Write-Log "ERROR" "Alembic revision command failed."
    Write-Log "ERROR" $_.Exception.Message
    exit 1
}
exit 0